<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Inventaris Barang (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        /* Style untuk loader */
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%; left: 50%;
            margin-left: -25px;
            margin-top: 25px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl lg:max-w-screen-xl">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">ðŸ“¦ Aplikasi Inventaris ruangan Aprikot</h1>
            <p class="text-gray-500 mt-2">Ingat kata bijak Pak Agus :<br>"Jika Masalahmu tidak ada jalan keluar , maka kami yang akan jalan- jalan keluar"</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-md hidden lg:block mb-8">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Informasi Tambahan</h3>
                    <p class="text-sm text-gray-600">
                        Sistem inventaris ini membantu Anda melacak barang-barang di ruangan Aprikot dengan mudah.
                        Pastikan data selalu diperbarui untuk akurasi inventaris.
                    </p>
                    <ul class="mt-4 text-sm text-gray-700 space-y-2">
                        <li>
                            <span class="font-medium text-blue-600">Total Barang:</span> 
                            <span id="totalItemsDisplay">0</span>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="font-medium text-green-600">Berfungsi Baik:</span> 
                            <span id="kondisiBaikDisplay">0</span>
                            <button class="text-blue-500 hover:underline text-xs" data-status="Berfungsi dengan baik" data-action="view-status">Lihat</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="font-medium text-yellow-600">Rusak Ringan:</span> 
                            <span id="kondisiRusakRinganDisplay">0</span>
                            <button class="text-blue-500 hover:underline text-xs" data-status="Rusak ringan" data-action="view-status">Lihat</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="font-medium text-red-600">Rusak Total:</span> 
                            <span id="kondisiRusakTotalDisplay">0</span>
                            <button class="text-blue-500 hover:underline text-xs" data-status="Rusak Total" data-action="view-status">Lihat</button>
                        </li>
                        <li>
                            <span class="font-medium text-gray-600">Terakhir Diperbarui:</span> 
                            <span id="lastUpdateDisplay">N/A</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md hidden lg:block">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Distribusi Kondisi Barang</h3>
                    <div class="h-64"> <canvas id="kondisiBarangChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Daftar Barang Inventaris</h2>
                    <button id="openAddFormModalBtn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center justify-center shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        Tambah Barang Baru
                    </button>
                </div>
                
                <div class="flex flex-col md:flex-row items-center gap-4 w-full mb-4">
                    <input type="text" id="cariBarang" placeholder="ðŸ” Cari barang berdasarkan kode, nama, atau keterangan..." class="w-full md:flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm">
                    <button id="exportPdfButton" class="w-full md:w-auto bg-red-600 text-white px-4 py-2.5 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center text-sm shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export PDF
                    </button>
                </div>

                <div class="overflow-x-auto relative rounded-lg border border-gray-200">
                    <div id="loader" class="absolute inset-0 bg-white bg-opacity-75 flex justify-center items-center z-10 hidden">
                        <div class="loader-spinner"></div>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Gambar</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kode Barang</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Barang</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Satuan</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Keterangan</th>
                                <th class="p-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                    <p id="noResults" class="text-center text-gray-500 py-8 hidden">Tidak ada barang yang ditemukan.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="addBarangModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg modal-fade-in relative">
            <h2 id="formTitle" class="text-2xl font-semibold mb-4 pb-3 border-b text-gray-700">Tambah Barang Baru</h2>
            <form id="formBarang" class="space-y-4">
                <div>
                    <label for="kodeBarang" class="block text-sm font-medium text-gray-700 mb-1">Kode Barang</label>
                    <input type="text" id="kodeBarang" placeholder="Contoh: BRG-001" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required>
                </div>
                <div>
                    <label for="namaBarang" class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <input type="text" id="namaBarang" placeholder="Contoh: Laptop" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required>
                </div>
                <div>
                    <label for="jumlahBarang" class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="number" id="jumlahBarang" placeholder="Contoh: 10" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required>
                </div>
                <div>
                    <label for="satuanBarang" class="block text-sm font-medium text-gray-700 mb-1">Satuan</label>
                    <input type="text" id="satuanBarang" placeholder="Contoh: Unit, Pcs, Box" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" required>
                </div>
                <div>
                    <label for="keteranganBarang" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                    <select id="keteranganBarang" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm">
                        <option value="Berfungsi dengan baik">Berfungsi dengan baik</option>
                        <option value="Rusak ringan">Rusak ringan</option>
                        <option value="Rusak Total">Rusak Total</option>
                        <option value="">Lainnya (pilih jika tidak ada opsi di atas)</option>
                    </select>
                </div>
                <div>
                    <label for="gambarBarang" class="block text-sm font-medium text-gray-700 mb-1">Gambar Barang</label>
                    <input type="file" id="gambarBarang" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <img id="imagePreview" src="" alt="Pratinjau Gambar" class="mt-2 rounded-lg max-h-32 hidden border border-gray-200 object-cover"/>
                    <p class="text-xs text-gray-500 mt-1">Maksimal ukuran gambar: 500 KB</p>
                </div>
                <button id="submitButton" type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center justify-center">
                    + Tambah ke Inventaris
                </button>
            </form>
            <button id="closeAddFormModal" class="absolute -top-3 -right-3 bg-white rounded-full p-1.5 text-gray-800 hover:bg-gray-200 transition-all shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <div id="statusDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-2xl modal-fade-in relative">
            <h3 id="statusDetailTitle" class="text-xl font-bold mb-4 border-b pb-3 text-gray-700">Daftar Barang - Berfungsi Baik</h3>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kode</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Barang</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Satuan</th>
                        </tr>
                    </thead>
                    <tbody id="statusDetailTableBody" class="bg-white divide-y divide-gray-100">
                        </tbody>
                </table>
                <p id="noStatusResults" class="text-center text-gray-500 py-4 hidden">Tidak ada barang dengan status ini.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeStatusDetailModal" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all text-sm">Tutup</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm modal-fade-in">
            <h3 id="authTitle" class="text-lg font-bold">Autentikasi Diperlukan</h3>
            <p class="text-gray-600 my-2">Masukkan username dan password untuk melanjutkan.</p>
            <form id="authForm" class="space-y-4 mt-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm">
                </div>
                <p id="authError" class="text-red-500 text-sm hidden">Username atau password salah!</p>
                <div class="flex justify-end gap-4 pt-2">
                    <button type="button" id="cancelAuth" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all text-sm">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-sm">Lanjut</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirmActionModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm modal-fade-in">
            <h3 class="text-lg font-bold">Konfirmasi</h3>
            <p id="confirmMessage" class="text-gray-600 my-4">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelAction" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all text-sm">Tidak</button>
                <button id="confirmAction" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all text-sm">Ya</button>
            </div>
        </div>
    </div>
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4">
        <div class="relative">
            <img id="modalImage" src="" alt="Tampilan Penuh Gambar Barang" class="max-w-[90vw] max-h-[80vh] rounded-lg shadow-lg">
            <button id="closeImageModal" class="absolute -top-3 -right-3 bg-white rounded-full p-1.5 text-gray-800 hover:bg-gray-200 transition-all shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.js"></script>
    
    <script type="module">
        // --- Utility Function to Convert File to Base64 ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); 
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result); 
            reader.onerror = error => reject(error);
        });

        // Import fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyBP0atHEeRMxiT5ZV7_3lzMbKQMNQjuuN4",
            authDomain: "inventaris-28b9e.firebaseapp.com",
            projectId: "inventaris-28b9e",
            storageBucket: "inventaris-28b9e.appspot.com", 
            messagingSenderId: "186480577129",
            appId: "1:186480577129:web:bc53ec6492e4447b5830f8"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inventoryCollection = collection(db, "items");

        // Memastikan DOM sepenuhnya dimuat sebelum berinteraksi dengan elemen
        document.addEventListener('DOMContentLoaded', () => {

            // === ELEMEN DOM ===
            // Modal form utama
            const addBarangModal = document.getElementById('addBarangModal');
            const form = document.getElementById('formBarang'); 
            const formTitle = document.getElementById('formTitle'); 
            const submitButton = document.getElementById('submitButton');
            
            // Elemen-elemen input form
            const kodeBarangInput = document.getElementById('kodeBarang');
            const namaBarangInput = document.getElementById('namaBarang');
            const jumlahBarangInput = document.getElementById('jumlahBarang');
            const satuanBarangInput = document.getElementById('satuanBarang');
            const keteranganBarangInput = document.getElementById('keteranganBarang'); 
            const imageInput = document.getElementById('gambarBarang');
            const imagePreview = document.getElementById('imagePreview');

            // Tombol dan elemen tampilan lainnya
            const openAddFormModalBtn = document.getElementById('openAddFormModalBtn');
            const closeAddFormModalBtn = document.getElementById('closeAddFormModal');
            const tableBody = document.getElementById('inventoryTableBody');
            const searchInput = document.getElementById('cariBarang');
            const noResults = document.getElementById('noResults');
            const loader = document.getElementById('loader');
            const exportPdfButton = document.getElementById('exportPdfButton');

            // Elemen tampilan tambahan di kolom kiri
            const totalItemsDisplay = document.getElementById('totalItemsDisplay');
            const kondisiBaikDisplay = document.getElementById('kondisiBaikDisplay');
            const kondisiRusakRinganDisplay = document.getElementById('kondisiRusakRinganDisplay');
            const kondisiRusakTotalDisplay = document.getElementById('kondisiRusakTotalDisplay');
            const lastUpdateDisplay = document.getElementById('lastUpdateDisplay');

            // Elemen Canvas untuk Diagram
            const kondisiBarangChartCanvas = document.getElementById('kondisiBarangChart');
            let kondisiBarangChart; // Variabel untuk menyimpan instance chart


            // Modal Autentikasi
            const authModal = document.getElementById('authModal');
            const authForm = document.getElementById('authForm');
            const authTitle = document.getElementById('authTitle');
            const authError = document.getElementById('authError');
            const cancelAuthBtn = document.getElementById('cancelAuth');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password'); 

            // Modal Konfirmasi
            const confirmActionModal = document.getElementById('confirmActionModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelActionBtn = document.getElementById('cancelAction');
            const confirmActionBtn = document.getElementById('confirmAction');

            // Modal Tampilan Gambar
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeImageModalBtn = document.getElementById('closeImageModal');

            // Modal Baru: Status Detail
            const statusDetailModal = document.getElementById('statusDetailModal');
            const statusDetailTitle = document.getElementById('statusDetailTitle');
            const statusDetailTableBody = document.getElementById('statusDetailTableBody');
            const noStatusResults = document.getElementById('noStatusResults');
            const closeStatusDetailModalBtn = document.getElementById('closeStatusDetailModal');


            // === STATE APLIKASI ===
            let inventory = []; // Menyimpan semua data inventaris
            let currentAction = null; // Menyimpan aksi yang sedang dikonfirmasi (edit/delete)
            let actionItemId = null; // Menyimpan ID item yang sedang dalam aksi (edit/delete)
            let editItemId = null; // Menyimpan ID item yang sedang diedit


            // === FUNGSI-FUNGSI UTILITY ===
            function showLoader() { loader.classList.remove('hidden'); }
            function hideLoader() { loader.classList.add('hidden'); }
            function showModal(modal) { modal.classList.remove('hidden'); }
            function hideModal(modal) { modal.classList.add('hidden'); }
            
            const MAX_IMAGE_SIZE_BYTES = 500 * 1024; // 500 KB
            
            // Fungsi untuk memuat data inventaris dari Firebase
            async function loadInventory() {
                showLoader();
                onSnapshot(inventoryCollection, (snapshot) => {
                    inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTable(inventory);
                    updateDashboardStats(inventory); // Mengirim seluruh array inventaris
                    updateKondisiChart(inventory); // Memperbarui diagram batang
                    hideLoader();
                }, (error) => {
                    console.error("Error loading inventory: ", error);
                    alert("Gagal memuat data dari server.");
                    hideLoader();
                });
            }

            // Fungsi untuk memperbarui statistik dashboard
            function updateDashboardStats(data) {
                const totalItems = data.length;
                const baik = data.filter(item => item.description === 'Berfungsi dengan baik').length;
                const rusakRingan = data.filter(item => item.description === 'Rusak ringan').length;
                const rusakTotal = data.filter(item => item.description === 'Rusak Total').length;

                if (totalItemsDisplay) totalItemsDisplay.textContent = totalItems;
                if (kondisiBaikDisplay) kondisiBaikDisplay.textContent = baik;
                if (kondisiRusakRinganDisplay) kondisiRusakRinganDisplay.textContent = rusakRingan;
                if (kondisiRusakTotalDisplay) kondisiRusakTotalDisplay.textContent = rusakTotal;
                
                if (lastUpdateDisplay) {
                    lastUpdateDisplay.textContent = new Date().toLocaleString('id-ID', {
                        day: '2-digit', month: 'short', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                }
            }

            // Fungsi untuk memperbarui Diagram Batang
            function updateKondisiChart(data) {
                const baik = data.filter(item => item.description === 'Berfungsi dengan baik').length;
                const rusakRingan = data.filter(item => item.description === 'Rusak ringan').length;
                const rusakTotal = data.filter(item => item.description === 'Rusak Total').length;

                const chartData = {
                    labels: ['Berfungsi Baik', 'Rusak Ringan', 'Rusak Total'],
                    datasets: [{
                        label: 'Jumlah Barang',
                        data: [baik, rusakRingan, rusakTotal],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)', // Hijau-biru untuk Baik
                            'rgba(255, 206, 86, 0.7)', // Kuning-oranye untuk Rusak Ringan
                            'rgba(255, 99, 132, 0.7)'  // Merah untuk Rusak Total
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false, // Penting untuk kontrol ukuran di div parent
                    plugins: {
                        legend: {
                            display: false // Sembunyikan legenda karena label sudah jelas
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Kondisi Barang',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#4B5563' // gray-700
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Pastikan sumbu Y adalah bilangan bulat
                            }
                        }
                    }
                };

                if (kondisiBarangChart) {
                    // Jika chart sudah ada, update datanya
                    kondisiBarangChart.data = chartData;
                    kondisiBarangChart.update();
                } else {
                    // Jika chart belum ada, inisialisasi yang baru
                    kondisiBarangChart = new Chart(kondisiBarangChartCanvas, {
                        type: 'bar',
                        data: chartData,
                        options: chartOptions
                    });
                }
            }


            // Fungsi untuk merender tabel inventaris
            function renderTable(data) {
                tableBody.innerHTML = '';
                noResults.classList.toggle('hidden', data.length > 0);

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const placeholderImg = 'https://placehold.co/60x60/e2e8f0/cbd5e0?text=Gambar'; 
                    row.innerHTML = `
                        <td class="p-3">
                            <button class="view-image-btn" data-img-src="${item.imageUrl || placeholderImg}">
                                <img src="${item.imageUrl || placeholderImg}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md cursor-pointer hover:opacity-75 transition-opacity border border-gray-200">
                            </button>
                        </td>
                        <td class="p-3 text-sm text-gray-800 font-medium">${item.code}</td>
                        <td class="p-3 text-sm text-gray-800">${item.name}</td>
                        <td class="p-3 text-sm text-gray-800">${item.quantity}</td>
                        <td class="p-3 text-sm text-gray-800">
                            <span class="px-2 py-1 text-xs font-medium tracking-wider text-green-800 bg-green-200 rounded-full">${item.unit}</span>
                        </td>
                        <td class="p-3 text-sm text-gray-600">${item.description || '-'}</td>
                        <td class="p-3 text-sm text-gray-800 text-center space-x-2">
                            <button data-id="${item.id}" class="edit-btn text-blue-600 hover:text-blue-800 font-semibold transition-all text-sm py-1 px-2 rounded">Edit</button>
                            <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold transition-all text-sm py-1 px-2 rounded">Hapus</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Fungsi untuk menampilkan daftar barang berdasarkan status
            function showItemsByStatus(status) {
                const filteredItems = inventory.filter(item => item.description === status);
                statusDetailTitle.textContent = `Daftar Barang - ${status}`;
                statusDetailTableBody.innerHTML = '';

                if (filteredItems.length === 0) {
                    noStatusResults.classList.remove('hidden');
                } else {
                    noStatusResults.classList.add('hidden');
                    filteredItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="p-3 text-sm text-gray-800 font-medium">${item.code}</td>
                            <td class="p-3 text-sm text-gray-800">${item.name}</td>
                            <td class="p-3 text-sm text-gray-800">${item.quantity}</td>
                            <td class="p-3 text-sm text-gray-800">${item.unit}</td>
                        `;
                        statusDetailTableBody.appendChild(row);
                    });
                }
                showModal(statusDetailModal);
            }

            // Fungsi untuk mengatur form ke mode "Tambah Barang Baru"
            function setCreateMode() {
                editItemId = null;
                form.reset(); // Mereset form
                imagePreview.classList.add('hidden');
                kodeBarangInput.disabled = false; // Mengaktifkan input kode barang
                formTitle.textContent = 'Tambah Barang Baru';
                submitButton.innerHTML = '+ Tambah ke Inventaris';
                submitButton.className = 'w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center justify-center';
            }

            // Fungsi untuk mengatur form ke mode "Edit Barang"
            function setEditMode(item) {
                editItemId = item.id;
                kodeBarangInput.value = item.code;
                kodeBarangInput.disabled = true; // Menonaktifkan input kode barang saat edit
                namaBarangInput.value = item.name;
                jumlahBarangInput.value = item.quantity;
                satuanBarangInput.value = item.unit;
                keteranganBarangInput.value = item.description; // Memuat nilai ke select
                
                if (item.imageUrl) {
                    imagePreview.src = item.imageUrl;
                    imagePreview.classList.remove('hidden');
                } else {
                    imagePreview.classList.add('hidden');
                }
                imageInput.value = ''; // Kosongkan input file
                formTitle.textContent = `Mengedit: ${item.name}`;
                submitButton.innerHTML = 'Simpan Perubahan';
                submitButton.className = 'w-full bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all flex items-center justify-center';
            }
            
            // Fungsi untuk menghapus item
            async function handleDelete(itemId) {
                const itemToDelete = inventory.find(item => item.id === itemId);
                if (!itemToDelete) return;
                
                showLoader();
                try {
                    await deleteDoc(doc(db, "items", itemId));
                } catch (error) {
                    console.error("Error deleting item: ", error);
                    alert("Gagal menghapus barang.");
                } finally {
                    hideLoader();
                }
            }

            // === EVENT LISTENERS ===
            
            // Event listener untuk tombol "Tambah Barang" (membuka modal)
            openAddFormModalBtn.addEventListener('click', function() {
                setCreateMode(); 
                showModal(addBarangModal);
            });

            // Event listener untuk tombol tutup modal form
            closeAddFormModalBtn.addEventListener('click', function() {
                hideModal(addBarangModal);
                setCreateMode(); 
            });

            addBarangModal.addEventListener('click', (e) => {
                if (e.target === addBarangModal) {
                    hideModal(addBarangModal);
                    setCreateMode(); 
                }
            });

            // Event listener untuk perubahan input gambar (pratinjau)
            imageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > MAX_IMAGE_SIZE_BYTES) {
                        alert(`Ukuran gambar terlalu besar! Maksimal ${MAX_IMAGE_SIZE_BYTES / (1024)} KB.`);
                        event.target.value = ''; 
                        imagePreview.src = ''; 
                        imagePreview.classList.add('hidden'); 
                        return; 
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = ''; 
                    imagePreview.classList.add('hidden'); 
                }
            });
            
            // Event listener untuk submit form tambah/edit barang
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menyimpan...`;

                const imageFile = imageInput.files[0]; 
                let imageUrl = null; 

                if (imageFile && imageFile.size > MAX_IMAGE_SIZE_BYTES) {
                    alert(`Ukuran gambar terlalu besar! Maksimal ${MAX_IMAGE_SIZE_BYTES / (1024)} KB.`);
                    submitButton.disabled = false;
                    submitButton.innerHTML = '+ Tambah ke Inventaris'; 
                    return; 
                }

                const itemData = {
                    code: kodeBarangInput.value.trim(), 
                    name: namaBarangInput.value.trim(),
                    quantity: parseInt(jumlahBarangInput.value),
                    unit: satuanBarangInput.value.trim(),
                    description: keteranganBarangInput.value, 
                };

                try {
                    if (editItemId) { // Mode Edit
                        const itemToUpdate = inventory.find(item => item.id === editItemId);
                        if (imageFile) {
                            imageUrl = await toBase64(imageFile);
                        } else {
                            imageUrl = itemToUpdate.imageUrl || null;
                        }
                        
                        itemData.imageUrl = imageUrl;
                        const itemRef = doc(db, "items", editItemId);
                        await setDoc(itemRef, itemData); 
                        hideModal(addBarangModal); // Tutup modal setelah simpan
                        setCreateMode(); // Reset form

                    } else { // Mode Tambah
                        const q = query(inventoryCollection, where("code", "==", itemData.code));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            alert('Kode barang sudah ada. Harap gunakan kode yang unik.');
                            submitButton.disabled = false;
                            submitButton.innerHTML = '+ Tambah ke Inventaris';
                            return; 
                        }
                        
                        if(imageFile) {
                            imageUrl = await toBase64(imageFile);
                        }
                        itemData.imageUrl = imageUrl;
                        await addDoc(inventoryCollection, itemData);
                        form.reset();
                        imagePreview.classList.add('hidden');
                        hideModal(addBarangModal); 
                    }
                } catch (error) {
                    console.error("Error saving data: ", error);
                    alert("Terjadi kesalahan saat menyimpan data.");
                } finally {
                    submitButton.disabled = false;
                    if (editItemId) { 
                        submitButton.innerHTML = 'Simpan Perubahan';
                    } else { 
                        submitButton.innerHTML = '+ Tambah ke Inventaris';
                    }
                }
            });
            
            // Event listener untuk tombol Edit/Delete di tabel utama dan tombol Lihat di informasi tambahan
            // Menggunakan event delegation pada 'document' untuk tombol yang dinamis
            document.addEventListener('click', function(event) {
                const target = event.target;
                const button = target.closest('button');
                if (!button) return; // Jika yang diklik bukan button, keluar

                // Menangani tombol "Lihat" di informasi tambahan
                if (button.dataset.action === 'view-status' && button.dataset.status) {
                    showItemsByStatus(button.dataset.status);
                    return; // Hentikan eksekusi lebih lanjut
                }

                // Menangani tombol Edit dari tabel
                if (button.classList.contains('edit-btn')) {
                    currentAction = 'edit';
                    actionItemId = button.dataset.id; // Simpan ID barang yang akan diedit
                    authTitle.textContent = 'Autentikasi untuk Mengedit';
                    showModal(authModal);
                    return; // Hentikan eksekusi lebih lanjut
                } 
                // Menangani tombol Delete dari tabel
                else if (button.classList.contains('delete-btn')) {
                    currentAction = 'delete';
                    actionItemId = button.dataset.id; // Simpan ID barang yang akan dihapus
                    authTitle.textContent = 'Autentikasi untuk Menghapus';
                    showModal(authModal);
                    return; // Hentikan eksekusi lebih lanjut
                } 
                // Menangani tombol View Image dari tabel
                else if (button.classList.contains('view-image-btn')) {
                    const imgSrc = button.dataset.imgSrc;
                    modalImage.src = imgSrc;
                    showModal(imageModal);
                    return; // Hentikan eksekusi lebih lanjut
                }
            });

            // Event listener untuk submit form autentikasi
            authForm.addEventListener('submit', function(event) {
                event.preventDefault();
                // Autentikasi: Ganti username/password jika diperlukan
                if (usernameInput.value === 'Aponk' && passwordInput.value === '2025') {
                    hideModal(authModal);
                    authForm.reset();
                    authError.classList.add('hidden');
                    
                    // Setelah autentikasi berhasil, tampilkan modal konfirmasi
                    confirmMessage.textContent = `Apakah Anda yakin ingin ${currentAction === 'edit' ? 'mengedit' : 'menghapus'} barang ini?`;
                    showModal(confirmActionModal);
                } else {
                    authError.classList.remove('hidden');
                }
            });
            
            // Event listener untuk konfirmasi aksi (setelah autentikasi)
            confirmActionBtn.addEventListener('click', function() {
                hideModal(confirmActionModal); // Tutup modal konfirmasi
                if (currentAction === 'delete') {
                    handleDelete(actionItemId);
                } else if (currentAction === 'edit') {
                    const itemToEdit = inventory.find(item => item.id === actionItemId);
                    if (itemToEdit) {
                        setEditMode(itemToEdit); // Isi form dengan data item
                        showModal(addBarangModal); // Tampilkan modal form barang yang sudah terisi
                    } else {
                        console.error("Item for edit not found with ID:", actionItemId);
                        alert("Barang yang akan diedit tidak ditemukan.");
                    }
                }
            });

            // Event listener untuk pencarian barang
            searchInput.addEventListener('input', function() {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = inventory.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.code.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                );
                renderTable(filtered);
            });
            
            // Event listeners untuk menutup modal-modal lainnya
            cancelAuthBtn.addEventListener('click', () => { hideModal(authModal); authForm.reset(); authError.classList.add('hidden'); });
            cancelActionBtn.addEventListener('click', () => hideModal(confirmActionModal));
            authModal.addEventListener('click', (e) => e.target === authModal && hideModal(authModal));
            confirmActionModal.addEventListener('click', (e) => e.target === confirmActionModal && hideModal(confirmActionModal));
            closeImageModalBtn.addEventListener('click', () => hideModal(imageModal));
            imageModal.addEventListener('click', (e) => e.target === imageModal && hideModal(imageModal));
            closeStatusDetailModalBtn.addEventListener('click', () => hideModal(statusDetailModal));
            statusDetailModal.addEventListener('click', (e) => {
                if (e.target === statusDetailModal) hideModal(statusDetailModal);
            });


            // Event listener untuk ekspor PDF
            exportPdfButton.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'legal' });
                doc.setFontSize(18);
                doc.text('Daftar Inventaris Barang - Ruangan Aprikot', 40, 40);

                const tableData = inventory.map(item => [
                    '', 
                    item.code,
                    item.name,
                    item.quantity,
                    item.unit,
                    item.description || '-'
                ]);

                doc.autoTable({
                    head: [['Gambar', 'Kode', 'Nama Barang', 'Jumlah', 'Satuan', 'Keterangan']],
                    body: tableData,
                    startY: 60, theme: 'grid', styles: { fontSize: 10, cellPadding: 6, valign: 'middle' },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    columnStyles: { 0: { minCellWidth: 50, minCellHeight: 50 } },
                    didDrawCell: function(data) {
                        if (data.column.index === 0 && data.cell.section === 'body') {
                            const item = inventory[data.row.index];
                            if (item.imageUrl) {
                                try {
                                    const img = new Image();
                                    img.src = item.imageUrl;
                                    const imgWidth = 40;
                                    const imgHeight = 40;
                                    const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                                    const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                                    doc.addImage(img, 'JPEG', x, y, imgWidth, imgHeight); 
                                } catch (e) {
                                    console.error(`Error adding image for item ${item.code}:`, e);
                                }
                            }
                        }
                    }
                });
                doc.save('inventaris-ruangan-aprikot.pdf');
            });
            
            // === INISIALISASI ===
            loadInventory();

        }); // Akhir dari DOMContentLoaded
    </script>
</body>
</html>
